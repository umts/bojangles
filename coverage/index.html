<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Bojangles</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.10.0/application.js' type='text/javascript'></script>    
    <link href='./assets/0.10.0/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.10.0/favicon_yellow.png" />
    <link rel="icon" type="image/png" href="./assets/0.10.0/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.10.0/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2017-02-02T12:48:21-05:00">2017-02-02T12:48:21-05:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="yellow">84.19%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         5724.51
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>3</b> files in total.
    <b>253</b> relevant lines. 
    <span class="green"><b>213</b> lines covered</span> and
    <span class="red"><b>40</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#c895461ed9d6478f07b1ecfa2f4c47c51ea0bc29" class="src_link" title="lib/bojangles.rb">lib/bojangles.rb</a></td>
        <td class="green strong">97.83 %</td>
        <td>142</td>
        <td>92</td>
        <td>90</td>
        <td>2</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#63b852d27b19f5db56e29d8eff8fb4bfc15d7a1c" class="src_link" title="lib/departure_comparator.rb">lib/departure_comparator.rb</a></td>
        <td class="yellow strong">83.87 %</td>
        <td>77</td>
        <td>31</td>
        <td>26</td>
        <td>5</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#24c2ac01cacced6e9d7c782ceb8820f2bb7b14d6" class="src_link" title="lib/gtfs_parser.rb">lib/gtfs_parser.rb</a></td>
        <td class="red strong">74.62 %</td>
        <td>222</td>
        <td>130</td>
        <td>97</td>
        <td>33</td>
        <td>11139.0</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Controllers"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Models"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Mailers"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Helpers"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Jobs"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent"><span class="yellow">84.19%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         5724.51
       </span>
    </span> hits/line)
  </h2>
  <a name="Libraries"></a>
  <div>
    <b>3</b> files in total.
    <b>253</b> relevant lines. 
    <span class="green"><b>213</b> lines covered</span> and
    <span class="red"><b>40</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#c895461ed9d6478f07b1ecfa2f4c47c51ea0bc29" class="src_link" title="lib/bojangles.rb">lib/bojangles.rb</a></td>
        <td class="green strong">97.83 %</td>
        <td>142</td>
        <td>92</td>
        <td>90</td>
        <td>2</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#63b852d27b19f5db56e29d8eff8fb4bfc15d7a1c" class="src_link" title="lib/departure_comparator.rb">lib/departure_comparator.rb</a></td>
        <td class="yellow strong">83.87 %</td>
        <td>77</td>
        <td>31</td>
        <td>26</td>
        <td>5</td>
        <td>1.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#24c2ac01cacced6e9d7c782ceb8820f2bb7b14d6" class="src_link" title="lib/gtfs_parser.rb">lib/gtfs_parser.rb</a></td>
        <td class="red strong">74.62 %</td>
        <td>222</td>
        <td>130</td>
        <td>97</td>
        <td>33</td>
        <td>11139.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.13.0 
        and simplecov-html v0.10.0<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="c895461ed9d6478f07b1ecfa2f4c47c51ea0bc29">
  <div class="header">
    <h3>lib/bojangles.rb</h3>
    <h4><span class="green">97.83 %</span> covered</h4>
    <div>
      <b>92</b> relevant lines. 
      <span class="green"><b>90</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;active_support/core_ext/object/blank&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;active_support/core_ext/hash/conversions&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;digest&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;net/http&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;pony&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;pry-byebug&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;departure_comparator&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">include DepartureComparator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"># Bojangles is the main driver of the script, and is responsible for communicating</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"># with the Avail realtime feed.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">module Bojangles</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  if File.file? &#39;config.json&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    CONFIG = JSON.parse File.read(&#39;config.json&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  else raise &#39;No config file found. Please see the config.json.example file and create a config.json file to match.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  PVTA_API_URL = &#39;http://bustracker.pvta.com/InfoPoint/rest&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  ROUTES_URI = URI([PVTA_API_URL, &#39;routes&#39;, &#39;getvisibleroutes&#39;].join(&#39;/&#39;))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  STUDIO_ARTS_BUILDING_ID = 72 # TODO: get from stops.txt instead of writing here</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  DEPARTURES_URI = URI([PVTA_API_URL, &#39;stopdepartures&#39;, &#39;get&#39;, STUDIO_ARTS_BUILDING_ID].join(&#39;/&#39;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  MAIL_SETTINGS = CONFIG.fetch(&#39;mail_settings&#39;).symbolize_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  CACHED_ROUTES_FILE = &#39;route_mappings.json&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # Cache the mapping from avail route ID to route number</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def cache_route_mappings!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    response = JSON.parse(Net::HTTP.get(ROUTES_URI))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    routes = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    response.each do |route|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      real_name = route.fetch &#39;ShortName&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      avail_id = route.fetch &#39;RouteId&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      routes[avail_id] = real_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    File.open CACHED_ROUTES_FILE, &#39;w&#39; do |file|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">      file.puts routes.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  # Fetch the cached route mappings</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def cached_route_mappings</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="46">
          <span class="hits">3</span>
          
          <code class="ruby">    JSON.parse File.read(CACHED_ROUTES_FILE)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # Return the hash mapping route number and headsign to the provided time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_avail_departure_times!</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="51">
          <span class="hits">2</span>
          
          <code class="ruby">    times = {}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="52">
          <span class="hits">2</span>
          
          <code class="ruby">    stop_departure = JSON.parse(Net::HTTP.get(DEPARTURES_URI)).first</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">    route_directions = stop_departure.fetch &#39;RouteDirections&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="54">
          <span class="hits">2</span>
          
          <code class="ruby">    route_directions.each do |route|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="55">
          <span class="hits">4</span>
          
          <code class="ruby">      route_id = route.fetch(&#39;RouteId&#39;).to_s</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="56">
          <span class="hits">4</span>
          
          <code class="ruby">      route_number = cached_route_mappings[route_id]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="57">
          <span class="hits">4</span>
          
          <code class="ruby">      departure = route.fetch(&#39;Departures&#39;).first</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="58">
          <span class="hits">4</span>
          
          <code class="ruby">      next unless departure.present?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">      departure_time = departure.fetch &#39;SDT&#39; # scheduled departure time</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">      trip = departure.fetch &#39;Trip&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="61">
          <span class="hits">2</span>
          
          <code class="ruby">      headsign = trip.fetch &#39;InternetServiceDesc&#39; # headsign</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="62">
          <span class="hits">2</span>
          
          <code class="ruby">      times[[route_number, headsign]] = parse_json_unix_timestamp(departure_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="64">
          <span class="hits">2</span>
          
          <code class="ruby">    times</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  # Cache the error messages</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  def cache_error_messages!(current_errors)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="69">
          <span class="hits">2</span>
          
          <code class="ruby">    File.open &#39;error_messages.json&#39;, &#39;w&#39; do |file|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="70">
          <span class="hits">2</span>
          
          <code class="ruby">      file.puts current_errors.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  # Fetch the cached error messages</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def cached_error_messages</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="76">
          <span class="hits">6</span>
          
          <code class="ruby">    if File.file? &#39;error_messages.json&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      JSON.parse File.read(&#39;error_messages.json&#39;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="78">
          <span class="hits">5</span>
          
          <code class="ruby">    else []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  def go!</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="83">
          <span class="hits">3</span>
          
          <code class="ruby">    error_messages, statuses = DepartureComparator.compare</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="84">
          <span class="hits">3</span>
          
          <code class="ruby">    current_time = Time.now</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>
          
          <code class="ruby">    new_error_messages = error_messages - cached_error_messages</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="86">
          <span class="hits">3</span>
          
          <code class="ruby">    resolved_error_messages = cached_error_messages - error_messages</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="87">
          <span class="hits">3</span>
          
          <code class="ruby">    if new_error_messages.present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">      MAIL_SETTINGS[:html_body] = message_html(new_error_messages)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">      if CONFIG[&#39;environment&#39;] == &#39;development&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">        MAIL_SETTINGS[:via] = :smtp</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">        MAIL_SETTINGS[:via_options] = { address: &#39;localhost&#39;, port: 1025 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">      Pony.mail MAIL_SETTINGS</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">      update_log_file! to: { current_time: current_time, new_error: new_error_messages }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">      cache_error_messages!(new_error_messages)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="97">
          <span class="hits">3</span>
          
          <code class="ruby">    if resolved_error_messages.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      update_log_file! to: { current_time: current_time, error_resolved: resolved_error_messages }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">  def message_html(error_messages)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="103">
          <span class="hits">2</span>
          
          <code class="ruby">    message = [&quot;This message brought to you by Bojangles, UMass Transit&#39;s monitoring service for the PVTA realtime bus departures feed.&quot;]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="104">
          <span class="hits">2</span>
          
          <code class="ruby">    message &lt;&lt; message_list(error_messages)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="105">
          <span class="hits">2</span>
          
          <code class="ruby">    message.flatten.join &#39;&lt;br&gt;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  def message_list(error_messages)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="109">
          <span class="hits">2</span>
          
          <code class="ruby">    heading = &#39;Bojangles has noticed the following errors:&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="110">
          <span class="hits">2</span>
          
          <code class="ruby">    list = &#39;&lt;ul&gt;&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="111">
          <span class="hits">2</span>
          
          <code class="ruby">    error_messages.each do |error|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="112">
          <span class="hits">3</span>
          
          <code class="ruby">      list &lt;&lt; &#39;&lt;li&gt;&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="113">
          <span class="hits">3</span>
          
          <code class="ruby">      error.split(&quot;\n&quot;).each do |line|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="114">
          <span class="hits">3</span>
          
          <code class="ruby">        list &lt;&lt; line</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="115">
          <span class="hits">3</span>
          
          <code class="ruby">        list &lt;&lt; &#39;&lt;br&gt;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="117">
          <span class="hits">3</span>
          
          <code class="ruby">      list &lt;&lt; &#39;&lt;/li&gt;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="119">
          <span class="hits">2</span>
          
          <code class="ruby">    list &lt;&lt; &#39;&lt;/ul&gt;&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="120">
          <span class="hits">2</span>
          
          <code class="ruby">    [heading, list]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_json_unix_timestamp(timestamp)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    matches = timestamp.match /\/Date\((\d+)000-0(4|5)00\)\//</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    Time.at matches.captures.first.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_log_file!(to:)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="129">
          <span class="hits">4</span>
          
          <code class="ruby">    FileUtils.mkdir_p LOG</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="130">
          <span class="hits">4</span>
          
          <code class="ruby">    File.open File.join(LOG, &quot;#{todays_date}.txt&quot;), &#39;a&#39; do |file|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="131">
          <span class="hits">4</span>
          
          <code class="ruby">      time = &#39;[&#39; + to[:current_time].strftime(&#39;%h %d %Y %R&#39;) + &#39;]&#39;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="132">
          <span class="hits">4</span>
          
          <code class="ruby">      to.delete(:current_time)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="133">
          <span class="hits">4</span>
          
          <code class="ruby">      to.keys.each do |error_type|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="134">
          <span class="hits">4</span>
          
          <code class="ruby">        to[error_type].each do |error_message|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="135">
          <span class="hits">6</span>
          
          <code class="ruby">          file.puts &lt;&lt;-LOG_ENTRY</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">#{time} #{error_type.to_s.humanize}: &quot;#{error_message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">          LOG_ENTRY</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="63b852d27b19f5db56e29d8eff8fb4bfc15d7a1c">
  <div class="header">
    <h3>lib/departure_comparator.rb</h3>
    <h4><span class="yellow">83.87 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;active_support/core_ext/string/strip&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require_relative &#39;gtfs_parser&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">include GtfsParser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"># DepartureComparator compares the scheduled departures from the GTFS data and</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># the departures obtained from the realtime feed.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">module DepartureComparator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # How many hours in the future can we expect the realtime feed to return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # departures on a given route?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  DEPARTURE_FUTURE_HOURS = 3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # Returns an array of messages and of statuses by comparing the GTFS scheduled departures</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # to the departures returned by the Avail endpoint</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def compare</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    @messages = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    @statuses = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      feed_down: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      missing_routes: [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      incorrect_times: []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      avail_times = Bojangles.get_avail_departure_times!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    rescue SocketError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      report_feed_down</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    gtfs_times = soonest_departures_within DEPARTURE_FUTURE_HOURS * 60</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # Look through each scheduled route, and make sure that each route is present,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    # and that the next reported departure has the correct scheduled time.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    gtfs_times.each do |(route_number, _direction_id), (headsign, last_time, next_time)|</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="32">
          <span class="hits">5</span>
          
          <code class="ruby">      if avail_times.key? [route_number, headsign]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        avail_time = avail_times.fetch [route_number, headsign]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        # if Avail&#39;s returned SDT is before now, check that it&#39;s the last scheduled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        # departure from the stop (i.e. the bus is running late).</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        if avail_time &lt; Time.now &amp;&amp; avail_time != last_time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          report_incorrect_departure route_number, headsign, last_time, avail_time, &#39;past&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        # if the returned SDT is after now, check that it&#39;s the next scheduled departure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        elsif avail_time &gt;= Time.now &amp;&amp; avail_time != next_time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">          report_incorrect_departure route_number, headsign, next_time, avail_time, &#39;future&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="42">
          <span class="hits">5</span>
          
          <code class="ruby">      else report_missing_route route_number, headsign, next_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    [@messages, @statuses]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  # a nicer-looking format of a time.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def email_format(time)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="50">
          <span class="hits">12</span>
          
          <code class="ruby">    time.strftime &#39;%r&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def report_feed_down</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    @messages &lt;&lt; &lt;&lt;-message.strip_heredoc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      The realtime feed is inaccessible via HTTP.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    @statuses[:feed_down] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def report_missing_route(route_number, headsign, gtfs_time)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    @messages &lt;&lt; &lt;&lt;-message.strip_heredoc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      Route #{route_number} with headsign #{headsign} is missing:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        Expected to be departing from Studio Arts Building</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        Expected scheduled departure time #{email_format gtfs_time}</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="65">
          <span class="hits">6</span>
          
          <code class="ruby">    message</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="66">
          <span class="hits">6</span>
          
          <code class="ruby">    @statuses[:missing_routes] &lt;&lt; route_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  def report_incorrect_departure(route_number, headsign, gtfs_time, avail_time, type)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    @messages &lt;&lt; &lt;&lt;-message.strip_heredoc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      Incorrect route #{route_number} departure with headsign #{headsign}:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">        Saw #{type} departure time, expected to be #{email_format gtfs_time};</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        Received #{email_format avail_time}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    @statuses[:incorrect_times] &lt;&lt; route_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="24c2ac01cacced6e9d7c782ceb8820f2bb7b14d6">
  <div class="header">
    <h3>lib/gtfs_parser.rb</h3>
    <h4><span class="red">74.62 %</span> covered</h4>
    <div>
      <b>130</b> relevant lines. 
      <span class="green"><b>97</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># frozen_string_literal: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fileutils&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;net/http&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;zipruby&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">module GtfsParser</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  LOCAL_GTFS_DIR = File.expand_path(&#39;../../gtfs/&#39;, __FILE__)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  STOP_NAME = &#39;Studio Arts Building&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  CACHE_FILE = &#39;cached_departures.json&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  GTFS_PROTOCOL = &#39;http://&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  GTFS_HOST = &#39;pvta.com&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  GTFS_PATH = &#39;/g_trans/google_transit.zip&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  LOG = File.expand_path(&#39;../../log&#39;, __FILE__)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def prepare!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    zip_log_file!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    get_new_files! unless files_up_to_date?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    cache_departures!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # Returns a hash which you can query by route number and direction,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # and which stores the headsign of the next departure,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  # the next scheduled departure,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # and the previous scheduled departure.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # Example:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # {[&#39;31&#39;, &#39;0&#39;] =&gt; [&#39;Sunderland&#39;, &#39;13:51:00&#39;, &#39;14:06:00&#39;]}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def soonest_departures_within(minutes)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    departure_times = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    cached_departures.each do |(route_number, direction_id, headsign), times|</code>
        </li>
      
        <li class="covered" data-hits="125" data-linenumber="32">
          <span class="hits">125</span>
          
          <code class="ruby">      next_time = times.find { |time| time_within? minutes, time }</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="33">
          <span class="hits">10</span>
          
          <code class="ruby">      next unless next_time</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="34">
          <span class="hits">6</span>
          
          <code class="ruby">      last_time = times[times.index(next_time) - 1] unless next_time == times.first</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="35">
          <span class="hits">6</span>
          
          <code class="ruby">      times_in_same_route_direction = departure_times[[route_number, direction_id]]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="36">
          <span class="hits">6</span>
          
          <code class="ruby">      unless times_in_same_route_direction &amp;&amp; times_in_same_route_direction.last &lt; next_time</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="37">
          <span class="hits">5</span>
          
          <code class="ruby">        departure_times[[route_number, direction_id]] = [headsign, last_time, next_time]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    departure_times</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # Stores departures in the cache file.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def cache_departures!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    departures = find_departures</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    File.open CACHE_FILE, &#39;w&#39; do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      file.puts departures.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  # Zip yesterday&#39;s log file into an archive directory, with filenames indicating the date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def zip_log_file!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    if File.file? &quot;#{todays_date}.txt&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      # At 4am, so todays_date log file is yesterday&#39;s log file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      FileUtils.mkdir_p LOG</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      zipfile = File.open &quot;#{todays_date}.txt&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      Zip::Archive.open_buffer zipfile do |archive|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        archive.each do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          file_path = File.join LOG, file.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          File.open file_path, &#39;w&#39; do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">            f &lt;&lt; file.read</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  # Retrieves the cached departures.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def cached_departures</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    departures = JSON.parse(File.read(CACHE_FILE))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    parsed_departures = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    departures.each do |route_data, times|</code>
        </li>
      
        <li class="covered" data-hits="276" data-linenumber="75">
          <span class="hits">276</span>
          
          <code class="ruby">      parsed_departures[JSON.parse(route_data)] = times.map { |time| parse_time time }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    parsed_departures</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  # Is the remote GTFS archive more recent than our cached files?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def files_up_to_date?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    return false unless File.directory? LOCAL_GTFS_DIR</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    http = Net::HTTP.new GTFS_HOST</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      response = http.head GTFS_PATH</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    rescue SocketError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      mtime = DateTime.parse response[&#39;last-modified&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      mtime &lt; File.mtime(LOCAL_GTFS_DIR).to_datetime</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  # Find an array of the service IDs which are running today.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_service_ids_today</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    filename = [LOCAL_GTFS_DIR, &#39;calendar.txt&#39;].join &#39;/&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    entries = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    weekday_columns = %w(sunday monday tuesday wednesday thursday friday saturday)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    weekday = weekday_columns[todays_date.wday]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">    CSV.foreach filename, headers: true do |row|</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="101">
          <span class="hits">71</span>
          
          <code class="ruby">      service_id = row.fetch(&#39;service_id&#39;)</code>
        </li>
      
        <li class="covered" data-hits="71" data-linenumber="102">
          <span class="hits">71</span>
          
          <code class="ruby">      if service_id.include? &#39;UMTS&#39;</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="103">
          <span class="hits">41</span>
          
          <code class="ruby">        if row.fetch(weekday) == &#39;1&#39; # that is to say, if the service type runs today</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="104">
          <span class="hits">22</span>
          
          <code class="ruby">          start_date = Date.parse row.fetch(&#39;start_date&#39;)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="105">
          <span class="hits">22</span>
          
          <code class="ruby">          end_date = Date.parse row.fetch(&#39;end_date&#39;)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="106">
          <span class="hits">22</span>
          
          <code class="ruby">          entries &lt;&lt; service_id if (start_date..end_date).cover?(Date.today)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    entries</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  # Find the ID of the stop whose name is defined in STOP_NAME</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_stop_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    filename = [LOCAL_GTFS_DIR, &#39;stops.txt&#39;].join &#39;/&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    stop = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    CSV.foreach filename, headers: true do |row|</code>
        </li>
      
        <li class="covered" data-hits="1556" data-linenumber="118">
          <span class="hits">1556</span>
          
          <code class="ruby">      if row.fetch(&#39;stop_name&#39;).include? STOP_NAME</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">        stop = row</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">        break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    stop.fetch &#39;stop_id&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  # Returns a hash which is keyed by trip ID,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  # and which stores the trip&#39;s route ID, direction, and headsign</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_trips_operating_today</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    service_ids = find_service_ids_today</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">    filename = [LOCAL_GTFS_DIR, &#39;trips.txt&#39;].join &#39;/&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">    trips = {}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">    CSV.foreach filename, headers: true do |row|</code>
        </li>
      
        <li class="covered" data-hits="18309" data-linenumber="133">
          <span class="hits">18309</span>
          
          <code class="ruby">      if service_ids.include? row.fetch(&#39;service_id&#39;)</code>
        </li>
      
        <li class="covered" data-hits="674" data-linenumber="134">
          <span class="hits">674</span>
          
          <code class="ruby">        trips[row.fetch &#39;trip_id&#39;] = [row.fetch(&#39;route_id&#39;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">                                      row.fetch(&#39;direction_id&#39;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">                                      row.fetch(&#39;trip_headsign&#39;)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">    trips</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  # Given the trips operating day and the ID of the stop at STOP_NAME,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  # find the departures at that route.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  # This is a hash keyed by route ID, direction, and headsign,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  # and which stores a sorted array of departure times.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_departures</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    filename = [LOCAL_GTFS_DIR, &#39;stop_times.txt&#39;].join &#39;/&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">    stop_id = find_stop_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    trips = find_trips_operating_today</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    # Track the indices so that for each row, we can always include the row after it.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">    rows = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">    indices = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">    CSV.foreach(filename, headers: true).with_index do |row, index|</code>
        </li>
      
        <li class="covered" data-hits="470458" data-linenumber="154">
          <span class="hits">470458</span>
          
          <code class="ruby">      rows &lt;&lt; row &amp;&amp; next if indices.map(&amp;:succ).include? index # If the previous row has been saved</code>
        </li>
      
        <li class="covered" data-hits="470181" data-linenumber="155">
          <span class="hits">470181</span>
          
          <code class="ruby">      trip_id = row.fetch &#39;trip_id&#39;</code>
        </li>
      
        <li class="covered" data-hits="470181" data-linenumber="156">
          <span class="hits">470181</span>
          
          <code class="ruby">      if trips.key? trip_id</code>
        </li>
      
        <li class="covered" data-hits="12502" data-linenumber="157">
          <span class="hits">12502</span>
          
          <code class="ruby">        if row.fetch(&#39;stop_id&#39;) == stop_id</code>
        </li>
      
        <li class="covered" data-hits="277" data-linenumber="158">
          <span class="hits">277</span>
          
          <code class="ruby">          rows &lt;&lt; row</code>
        </li>
      
        <li class="covered" data-hits="277" data-linenumber="159">
          <span class="hits">277</span>
          
          <code class="ruby">          indices &lt;&lt; index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">    departures = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">    # If the departure&#39;s trip ID does not match the trip ID of the next row,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    # then it is the last stop in the trip, so it is not a departure.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    # For example, the last stop of an inbound 45 trip will be at Studio Arts Building,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    # but we do *not* want to report a departure with headsign UMass.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    # Basically, trips always end with a headsign change.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    rows.each_slice(2).map do |row, next_row| # Take the first of each pair if it matches</code>
        </li>
      
        <li class="covered" data-hits="277" data-linenumber="170">
          <span class="hits">277</span>
          
          <code class="ruby">      row if row.fetch(&#39;trip_id&#39;) == next_row.fetch(&#39;trip_id&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">    end.compact.each do |row|</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="172">
          <span class="hits">266</span>
          
          <code class="ruby">      trip_id = row.fetch &#39;trip_id&#39;</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="173">
          <span class="hits">266</span>
          
          <code class="ruby">      route_data = trips[trip_id]</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="174">
          <span class="hits">266</span>
          
          <code class="ruby">      departures[route_data] ||= []</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="175">
          <span class="hits">266</span>
          
          <code class="ruby">      departures[route_data] &lt;&lt; row.fetch(&#39;departure_time&#39;)</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="176">
          <span class="hits">266</span>
          
          <code class="ruby">      departures[route_data].sort!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">    departures</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  # Downloads the ZIP archive</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_new_files!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">    FileUtils.rm_rf LOCAL_GTFS_DIR</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">    FileUtils.mkdir_p LOCAL_GTFS_DIR</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">      zipfile = Net::HTTP.get URI(GTFS_PROTOCOL + GTFS_HOST + GTFS_PATH)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">    rescue SocketError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      return # TODO: notify that there&#39;s some problem</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    Zip::Archive.open_buffer zipfile do |archive|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">      archive.each do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">        file_path = File.join LOCAL_GTFS_DIR, file.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">        File.open file_path, &#39;w&#39; do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">          f &lt;&lt; file.read</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  # Parses a string time such as &#39;16:30:00&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  # into a Time object</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">  def parse_time(time)</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="203">
          <span class="hits">266</span>
          
          <code class="ruby">    hour, minute = time.split(&#39;:&#39;).map(&amp;:to_i)</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="204">
          <span class="hits">266</span>
          
          <code class="ruby">    date = Date.today</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="205">
          <span class="hits">266</span>
          
          <code class="ruby">    (hour -= 24) &amp;&amp; (date += 1) if hour &gt;= 24</code>
        </li>
      
        <li class="covered" data-hits="266" data-linenumber="206">
          <span class="hits">266</span>
          
          <code class="ruby">    Time.local date.year, date.month, date.day, hour, minute</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">  # Checks to see whether a time object falls within n minutes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="210">
          <span class="hits">1</span>
          
          <code class="ruby">  def time_within?(minutes, time)</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="211">
          <span class="hits">115</span>
          
          <code class="ruby">    compare_time = Time.now + (60 * minutes)</code>
        </li>
      
        <li class="covered" data-hits="115" data-linenumber="212">
          <span class="hits">115</span>
          
          <code class="ruby">    Time.now &lt; time &amp;&amp; time &lt; compare_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  # Between midnight and 4am, return yesterday.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">  def todays_date</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="217">
          <span class="hits">8</span>
          
          <code class="ruby">    if Time.now.hour &lt; 4</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">      Date.today - 1</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="219">
          <span class="hits">8</span>
          
          <code class="ruby">    else Date.today</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
